---
title: "Some discussion around Mixed models"
output: html_document
date: "2025-01-11"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

A usefull reference:

Glenn Williams (2022) R for Psych
<https://glennwilliams.me/r4psych/mixed-effects-models.html#generalised-mixed-effects-models>


# A first example:

We'll use the "CO2" dataset, which comes pre-installed with R. While it's not a neuroscience dataset, we can adapt it to demonstrate the principles of mixed models in a way that could be relevant to neuroscience research.

Here's the R code

```{r pressure, echo=FALSE}

# Load only the necessary libraries for analysis
library(lmerTest)
library(emmeans)

# Load the CO2 dataset (comes pre-installed with R)
data(CO2)

# Display the first few rows of the dataset
head(CO2)


# Fit the mixed model
model <- lmer(uptake ~ Type * Treatment + (1|Plant), data = CO2)

# Model summary
summary(model)

# ANOVA of the model
anova(model)

# Fixed effects estimates
fixef(model)

# Confidence intervals for fixed effects
confint(model)

# Post-hoc analysis using emmeans
emmeans_result <- emmeans(model, pairwise ~ Type | Treatment)
summary(emmeans_result)

# Basic plot (if ggplot2 is not available)
# Create a ggplot
ggplot(CO2, aes(x = Treatment, y = uptake, color = Type, group = Type)) +
  stat_summary(fun = mean, geom = "point", size = 3) +
  stat_summary(fun = mean, geom = "line") +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +
  theme_minimal() +
  labs(title = "CO2 Uptake by Treatment and Plant Type",
       x = "Treatment",
       y = "CO2 Uptake",
       color = "Plant Type") +
  scale_color_brewer(palette = "Set1")
```

Dataset Description and Characteristics:

1. Purpose: Originally about plant CO2 uptake, we can think of it as representing a neuroscience study on brain activity under different conditions.

2. Structure:
   - 2x2 factorial design with repeated measures
   - 12 plants (subjects)
   - 84 total observations
   - 2 fixed factors: 
     * Type (2 levels: Quebec, Mississippi)
     * Treatment (2 levels: nonchilled, chilled)
   - 1 random effect: Plant (subject)

3. Variables:
   - Plant: Subject identifier
   - Type: Plant type (Quebec or Mississippi), can be thought of as two groups of subjects
   - Treatment: Environmental condition (nonchilled or chilled), can be thought of as two experimental conditions
   - uptake: CO2 uptake rates, can be thought of as a measure of brain activity

4. Characteristics:
   - Repeated measures design
   - Balanced design
   - Real data, repurposed for a neuroscience-like context

5. Analysis Approach:
   - Mixed-effects model to account for both fixed (Type, Treatment) and random (Plant) effects
   - Main effects and interactions examined
   - Post-hoc analysis using emmeans to investigate specific group differences

This dataset, while not from neuroscience, can demonstrate principles of mixed models relevant to neuroscience research:
1. It has a factorial design with repeated measures
2. It includes multiple factors (subject group and experimental condition) common in neuroscience studies
3. It allows examination of main effects and interactions
4. It shows how to handle individual variability through random effects

The analysis includes model fitting, ANOVA, fixed effects estimation, confidence intervals, and post-hoc comparisons. The basic plot helps visualize the interaction between the two factors.

# (un)politeness of crossed random effects

This example is taken from and described in:
Bodo Winter (2013) A very basic tutorial for performing linear mixed effects analyses 

<//efaidnbmnnnibpcajpcglclefindmkaj/https://jontalle.web.engr.illinois.edu/MISC/lme4/bw_LME_tutorial.pdf>


```{r}
politeness=  read.csv("http://www.bodowinter.com/tutorial/politeness_data.csv") 
politeness$attitude=factor(politeness$attitude)
contrasts(politeness$attitude)=contr.sum
mod=lmer(frequency ~ attitude + gender+ (1|subject) + (0+attitude|subject) + (1|scenario), data=politeness) 
summary(mod)

```


## Plotting tools

for the first model:
```{r message=FALSE}
library(effects)
plot(allEffects(mod))

#plot random effects:
require(lattice)
qqmath(ranef(mod, condVar=TRUE))
```

The second model:
```{r,message=FALSE}
library(effects)
plot(allEffects(mod3))

#plot random effects:
require(lattice)
qqmath(ranef(mod3, condVar=TRUE))

# scatter plot
ggpairs(ranef(mod3, condVar=TRUE)$ID)+theme_bw()
```

An alternative plotting tool:

```{r message=FALSE}
library(sjPlot)
library(ggplot2)
plot_model(mod3, type = "pred", terms = c("Content","Scrambled", "Chan"))+theme_bw()
```


<https://courses.washington.edu/psy524a/_book/linear-mixed-models.html>

